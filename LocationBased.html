<!doctype html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">


    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/AR-js-org/AR.js/3.3.2/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v6.1.1/dist/aframe-extras.loaders.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="Styles.css">

    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <div class="container">
        <div class="logo-container">
            <img src="asset/University_of_Malaya-Logo.png" alt="UM Logo" class="logoTop">
            <img src="asset/UM.AR_Logo_Font_Black.png" alt="UM AR Logo" class="logoTop">
        </div>

        <a href="https://um-ar.netlify.app/main.html" class="backButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="50px" height="50px" fill="white"
                class="bi bi-arrow-left-circle-fill" viewBox="0 0 16 16">
                <path
                    d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0m3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z" />
            </svg>
        </a>

        <!-- Search bar form placed below the container -->

        <div class="notification-container">
            <div class="notification-box">
                <h4>You are near</h4>
                <h1>Faculty of Computer Science & Information Technology</h1>
                <p>Click here to view AR environment</p>
            </div>
            <img src="asset/middle_button/LocationNotification.png" alt="Location Icon" class="location-icon">
        </div>

        <form id="search-form">
            <input type="search" tabindex="-1" placeholder="Search here ..." autocomplete="off">
            <i class="fa fa-search"></i>
        </form>

        <div class="btn-content hidden">
            <a href="#" class="btn-custom">
                <span class="left title">Exit Navigation</span>
                <span class="right icon-container">
                    <i class="fas fa-sign-out-alt" style="transform: rotate(180deg);"></i>
                </span>
            </a>
        </div>

        <div id="cancel-button" class="cancel-btn-container">
            <i class="fa fa-times cancel-btn"></i>
        </div>

        <div id="suggestions-container" class="suggestions-container hidden">
        </div>
    </div>
    <div id="data-container" class="data-container" style="display:none;">
        <p id="userLocation" style="font-size:10px; top: 5px;  color: white; padding: 5px;"></p>
    </div>

    <div class="center-menu">
        <img src="asset/middle_button/we love the earth.png" alt="earth_img">
        <div class="center-circle">
            <h6>You are near</h6>
            <h3></h3>
            <p>click here to view environment</p>
        </div>
    </div>

    <div class="center-menu2 hidden">
        <img src="asset/middle_button/we love the earth.png" alt="earth_img">
        <div class="center-circle2">
            <h6>You are going to</h6>
            <h3></h3>
            <p>Click here to view full route</p>
        </div>
    </div>

    <div id="directions-container"></div>


    <!-- <div id="Loading" class="box">
        <div class="cat">
            <div class="cat__body"></div>
            <div class="cat__body"></div>
            <div class="cat__tail"></div>
            <div class="cat__head"></div>
        </div>
    </div> -->

    <div id="proximity-message" style="
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    text-align: center;
    display: none;
    z-index: 99999;
    transition: opacity 0.5s ease-in-out;
    ">
    </div>

    <div id="camera-facing-message" style="
    position: fixed;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    text-align: center;
    display: none;
    z-index: 1000;
    transition: opacity 0.5s ease-in-out;
    "></div>

    <div id="debug-message" style="
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    text-align: center;
    display: none;
    z-index: 1000;
    transition: opacity 0.5s ease-in-out;
    "></div>

    <!--  -->
    <a-scene renderer="logarithmicDepthBuffer: true; debugUIEnabled: false;" embedded loading-screen="enabled: false;"
        arjs="sourceType: webcam; cameraParametersUrl: camera_para.dat;" id="ar-scene">
        <a-assets>

            <img id="FSKTMLogo" src="asset/logo/Logo FSKTM.png">
            <a-asset-item id="animated-asset" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="FSKTM" src="asset/FSKTMAnim3.glb"></a-asset-item>

            <!-- Faculties -->
            <a-asset-item id="locationPinMedicine" src="asset/gltf_file/Fac_Medicine_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinEngineering"
                src="asset/gltf_file/Fac_Engineering_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinLaw" src="asset/gltf_file/Fac_Law_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinScience" src="asset/gltf_file/Fac_Science_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinCS" src="asset/gltf_file/FCSIT_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinBusiness"
                src="asset/gltf_file/Fac_Business_Econs_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinArts" src="asset/gltf_file/Fac_Art_Social_Sc_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinBuiltEnvironment"
                src="asset/gltf_file/Fac_Built_Env_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinDentistry" src="asset/gltf_file/Fac_Dentistry_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinEducation" src="asset/gltf_file/Fac_Edu_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinSport" src="asset/gltf_file/Fac_Sport_Science_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinLanguages" src="asset/gltf_file/Fac_Language_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinPharmacy" src="asset/gltf_file/Fac_Pharmacy_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinCreativeArts"
                src="asset/gltf_file/Fac_Creative_Arts_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinAkademiMelayu" src="asset/gltf_file/APM_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinAkademiIslam" src="asset/gltf_file/API_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinInstituteAdvancedStudies"
                src="asset/gltf_file/Advance_Studies_Checkpoint.glb"></a-asset-item>
            <a-asset-item id="locationPinPusatAsasi" src="asset/gltf_file/Pasum_Checkpoint.glb"></a-asset-item>

            <!-- Residential Colleges -->
            <a-asset-item id="locationPinKolej1" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej2" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej3" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej4" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej5" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej6" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej7" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej8" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej9" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej10" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej11" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej12" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKolej13" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinRumahUniversiti" src="asset/LocationPin.glb"></a-asset-item>

            <!-- Facilities -->
            <a-asset-item id="locationPinDTC" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinPanggung" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinKPS" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinBangunanCanseleri" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinExamHall" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinUMCentral" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinBankIslam" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinMasjid" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinAcademyIslam" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinTemple" src="asset/LocationPin.glb"></a-asset-item>

            <!-- Libraries -->
            <a-asset-item id="locationPinUMLibrary" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinMedicalLibrary" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinLawLibrary" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinZabaLibrary" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinDentalLibrary" src="asset/LocationPin.glb"></a-asset-item>
            <a-asset-item id="locationPinIslamicLibrary" src="asset/LocationPin.glb"></a-asset-item;>

                <!-- Sports and Recreation -->
                <a-asset-item id="locationPinUMWallSquash" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinVarsityGreen" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinUMPark" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinPadangC" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinKayaks" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinSwimmingPool" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinUMSportsCentre" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinUMArenaStadium" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinRimbaIlmu" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinLadangMini" src="asset/LocationPin.glb"></a-asset-item>
                <a-asset-item id="locationPinMustafaRiver" src="asset/LocationPin.glb"></a-asset-item>

                <!-- Environment -->
                <a-asset-item id="f315Scene" src="asset/AR_Environment_Info/F315.glb"></a-asset-item>
                <a-asset-item id="Scenescene" src="asset/AR_Environment_Info/Room.glb"></a-asset-item>

        </a-assets>

        <a-entity id="virtual-space" visible="false" follow-camera>
            <a-plane id="imagePlane" position="0 1 -10" width="4" height="3"
                material="src: asset/images/F315/image1.jpg;"></a-plane>
            <!-- <video id="videoPlane" width="640" height="360" autoplay loop muted>
                <source src="asset/videos/F315/video1.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video> -->

            <a-box position="0 1 -10" color=blue></a-box>
            <a-box position="0 1 10" color=red></a-box>
            <a-box position="10 1 0" color=yellow></a-box>
            <a-box position="-10 1 0" color=green></a-box>
        </a-entity>

        <!-- <a-entity id="dynamic-model"></a-entity> -->

        <a-camera gps-camera look-controls rotation-reader position="0 1.6 0"></a-camera>

        <!-- <script>
            AFRAME.registerComponent('follow-camera', {
                init: function () {
                    this.camera = document.querySelector('#camera');
                    this.virtualSpace = document.querySelector('#virtual-space');
                },

                tick: function () {
                    if (!this.camera || !this.virtualSpace) return;

                    // Get the camera's position
                    const cameraPosition = new THREE.Vector3();
                    this.camera.object3D.getWorldPosition(cameraPosition);

                    // Update the virtual space's position based on the camera's position
                    this.virtualSpace.object3D.position.set(cameraPosition.x, cameraPosition.y, cameraPosition.z);

                    // Optionally, make the virtual space a bit ahead of the camera
                    this.virtualSpace.object3D.position.z -= 5;  // Adjust this value as needed
                }
            });
        </script> -->

    </a-scene>

    <!-- Firebase Script -->
    <script type="module">
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";

        // Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyB1NEkxuhsfBrsTgfei80LWmF4o_IQwO8",
            authDomain: "um-ar-d0418.firebaseapp.com",
            databaseURL: "https://um-ar-d0418-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "um-ar-d0418",
            storageBucket: "um-ar-d0418.appspot.com",
            messagingSenderId: "624669072499",
            appId: "1:624669072499:web:315e91c12fad88513c6d52",
            measurementId: "G-XWM53Y6FBZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global array to store entities
        window.dynamicEntities = [];

        // Function to fetch entities from Firebase
        function fetchEntitiesNameCoordinate() {
            const entitiesRef = ref(database, "entities");
            onValue(entitiesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    window.dynamicEntities = []; // Reset the array
                    Object.keys(data).forEach((category) => {
                        Object.values(data[category]).forEach((entity) => {
                            window.dynamicEntities.push({
                                name: entity.name,
                                latitude: entity.latitude,
                                longitude: entity.longitude,
                                model: entity.model,
                            });
                        });
                    });
                } else {
                    console.error("No data found in the database.");
                }
            });
        }

        // Recursive Function to Fetch and Render Entities
        function renderEntities(node, parent = null) {
            Object.keys(node).forEach((key) => {
                const child = node[key];

                // If the child has `latitude` and `longitude`, it's an entity
                if (child.latitude && child.longitude) {
                    createAREntity(child, key, parent);
                } else if (typeof child === "object") {
                    // Recursively handle nested objects
                    renderEntities(child, key);
                }
            });
        }

        // Function to Create AR Entity
        window.createAREntity = function (entity, id, parentCategory = null) {
            const scene = document.querySelector("a-scene");
            const entityElement = document.createElement("a-entity");
            entityElement.setAttribute('data-entity-id', id);

            entityElement.classList.add('location-entity');
            entityElement.setAttribute("id", id);
            entityElement.setAttribute("gps-entity-place", `latitude: ${entity.latitude}; longitude: ${entity.longitude}`);
            entityElement.setAttribute("gltf-model", entity.model); // Model from database
            entityElement.setAttribute("scale", entity.scale || "1 1 1"); // Default scale if not provided
            entityElement.setAttribute("look-at", "[gps-camera]");
            entityElement.setAttribute("animation-mixer", "clip: *"); // Optional for animations

            // Optional Debugging
            showDebugMessage(`Added entity: ${id}, Parent Category: ${parentCategory}`);

            // Append to Scene
            scene.appendChild(entityElement);
        }

        // Re-fetch and render entities from the database
        window.fetchAndRenderEntities = function () {
            fetchEntitiesNameCoordinate();
            const entitiesRef = ref(database, "entities");
            onValue(entitiesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    renderEntities(data);  // Render all the entities after fetching the data
                } else {
                    console.error("No data found in the database.");
                }
            });
        }
        // Call the function after assigning it to window
        fetchAndRenderEntities();
    </script>
    <script>

        function clearClickEvent(btnContent) {
            btnContent.removeEventListener("click", handleExitClick);
        }

        function handleExitClick() {
            const searchForm = document.getElementById("search-form");
            const centerMenu = document.querySelector('.center-menu2');
            searchForm.style.display = 'block';
            
            clearMarkers();
            hideExitNav();

            centerMenu.style.animation = 'boink-reverse 0.5s ease-in-out forwards';

            setTimeout(() => {
                centerMenu.style.animation = 'none';
                fallBackCenterMenu();
            }, 500);
            
        }

        function recreateCenterMenu() {
            const oldMenu = document.querySelector('.center-menu2');
            const parent = oldMenu.parentElement;

            // Remove the old menu
            parent.removeChild(oldMenu);

            // Create a new menu element
            const newMenu = document.createElement('div');
            newMenu.className = 'center-menu2 hidden';
            newMenu.innerHTML = `
                <img src="asset/middle_button/we love the earth.png" alt="earth_img">
                <div class="center-circle2">
                    <h6>You are going to</h6>
                    <h3></h3>
                    <p>Click here to view full route</p>
                </div>
            `;

            // Append the new menu
            parent.appendChild(newMenu);
            return newMenu;
        }

        function fallBackCenterMenu() {
            recreateCenterMenu(); // Completely reset the element
        }


        function unhideExitNav() {
            const btnContent = document.querySelector('.btn-content');
            btnContent.classList.remove('hidden');

            // Add the event listener
            btnContent.addEventListener("click", handleExitClick);
        }

        function hideExitNav() {
            const btnContent = document.querySelector('.btn-content');
            btnContent.classList.add('hidden');

            // Remove the event listener
            clearClickEvent(btnContent);
        }

        //Show fata container for user position
        document.getElementById("data-container").style.display = "block";
        // Select form, input, suggestions container, and suggestion lists
        const searchForm = document.getElementById("search-form");
        const searchInput = searchForm.querySelector("input");
        const suggestionsContainer = document.getElementById("suggestions-container");

        // Ensure click handling for both search form and document works without conflicts
        searchForm.addEventListener("click", (event) => {
            renderPlaceNames();
            searchForm.classList.add("expanded");
            suggestionsContainer.classList.remove("hidden");
            suggestionsContainer.classList.add("show");
            animateSuggestions();
            event.stopPropagation();
        });

        document.addEventListener("click", (event) => {
            if (!searchForm.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                searchInput.value = '';
                resetFormAndSuggestions();
            }
        });

        function animateSuggestions() {
            const suggestionLists = suggestionsContainer.querySelectorAll(".suggestions-list");
            suggestionLists.forEach((list, index) => {
                if (index < 10) {
                    // Animate only the first 10 items
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            list.classList.add("animated");
                        }, index * 100); // Stagger animations for first 10 items
                    });
                } else {
                    // Delay showing the rest by 3 seconds
                    setTimeout(() => {
                        list.classList.add("animated");
                        list.style.opacity = '1';
                        list.style.transform = 'translateX(0)'; // Reset any transform
                    }, 1000);
                }
            });
        }


        // Function to reset form and hide suggestions
        function resetFormAndSuggestions() {
            searchForm.classList.remove('expanded');
            suggestionsContainer.classList.remove('show');

            suggestionsContainer.innerHTML = '';
            setTimeout(() => {
                suggestionsContainer.classList.add('hidden');
            }, 300); // Animation duration


        }

        // Function to render place names dynamically
        function renderPlaceNames() {
            const suggestionsContainer = document.querySelector(".suggestions-container");

            // Iterate through the global array
            window.dynamicEntities.forEach((entity) => {
                const suggestionList = document.createElement("div");
                suggestionList.className = "suggestions-list";

                const nameContainer = document.createElement("div");
                nameContainer.className = "suggestions-list-name";

                const placeName = document.createElement("h2");
                placeName.textContent = entity.name;

                nameContainer.appendChild(placeName);
                suggestionList.appendChild(nameContainer);

                suggestionList.addEventListener("click", () => {
                    searchInput.value = '';
                    clickSuggestion(entity);
                });

                suggestionsContainer.appendChild(suggestionList);
            });
        }

        function renderPlaceFilter(filterText = '') {
            const suggestionsContainer = document.querySelector('.suggestions-container');
            suggestionsContainer.innerHTML = ''; // Clear existing suggestions

            // Filter dynamicEntities based on filterText (case-insensitive)
            const filteredEntities = window.dynamicEntities.filter(entity =>
                entity.name.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filteredEntities.length === 0) {
                // If no results, show a "No results found" message
                const noResultsMessage = document.createElement('div');
                noResultsMessage.className = 'suggestions-list animated'; // Ensure animation applies
                noResultsMessage.textContent = 'No results found';
                suggestionsContainer.appendChild(noResultsMessage);
            } else {
                // Iterate through the filtered array
                filteredEntities.forEach((entity, index) => {
                    const suggestionList = document.createElement('div');
                    suggestionList.className = 'suggestions-list'; // Initially without the animated class

                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'suggestions-list-name';

                    const placeName = document.createElement('h2');
                    placeName.textContent = entity.name;

                    nameContainer.appendChild(placeName);
                    suggestionList.appendChild(nameContainer);

                    suggestionList.addEventListener('click', () => {
                        searchInput.value = '';
                        clickSuggestion(entity);
                    });

                    suggestionsContainer.appendChild(suggestionList);

                    // Add animation class after a short delay for visibility
                    setTimeout(() => {
                        suggestionList.classList.add('animated');
                    }, index * 50); // Optional stagger effect
                });
            }

            // Ensure the container is visible
            if (!suggestionsContainer.classList.contains('show')) {
                suggestionsContainer.classList.add('show');
            }
        }

        function clickSuggestion(entity) {

            fallBackCenterMenu();
            resetFormAndSuggestions();

            const searchForm = document.getElementById("search-form");
            const centerMenu = document.querySelector('.center-menu2');
            const centerCircleH3 = centerMenu.querySelector('.center-circle2 h3');

            searchForm.style.display = 'none';
            centerCircleH3.textContent = entity.name;
            centerMenu.classList.remove('hidden');
            setNavigationCoordinates(entity.latitude, entity.longitude);
            unhideExitNav();
        }

        searchInput.addEventListener('input', (event) => {
            const searchText = event.target.value;
            setTimeout(() => { // Small delay for better UX
                renderPlaceFilter(searchText);
            }, 0);
        });

        // Function to show debug messages in the div
        function showDebugMessage(message) {
            const debugDiv = document.getElementById("debug-message");
            debugDiv.innerText = message; // Set the message text
            debugDiv.style.display = "block"; // Make the div visible
            debugDiv.style.opacity = "1"; // Fade-in effect
        }

        // Function to hide the debug message
        function hideDebugMessage() {
            const debugDiv = document.getElementById("debug-message");
            debugDiv.style.opacity = "0"; // Fade-out effect
            setTimeout(() => {
                debugDiv.style.display = "none"; // Hide after fade-out
            }, 500); // Match this timeout with the CSS transition duration
        }

        // Function to update the latitude and longitude display
        function updateLocationDisplay(latitude, longitude) {
            document.getElementById('userLocation').innerText = 'Your Location: \n Latitude: ' + latitude.toFixed(6) + '\n' + 'Longitude: ' + longitude.toFixed(6);

            // Get the latitude and longitude of the object
            var entity = document.getElementById('entity');
            if (entity) {
                var objectLatLng = entity.getAttribute('gps-entity-place');
                if (objectLatLng) {
                    var objectLatitude = parseFloat(objectLatLng.latitude);
                    var objectLongitude = parseFloat(objectLatLng.longitude);
                    document.getElementById('objectLocation').innerText = 'Object Location: \n Latitude: ' + objectLatitude.toFixed(6) + '\n' + 'Longitude: ' + objectLongitude.toFixed(6);
                }
            }
        }

        // Haversine formula to calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = (lat1 * Math.PI) / 180;
            const φ2 = (lat2 * Math.PI) / 180;
            const Δφ = ((lat2 - lat1) * Math.PI) / 180;
            const Δλ = ((lon2 - lon1) * Math.PI) / 180;

            const a =
                Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        // Function to clear the virtual space and its entities
        function clearVirtualSpace() {
            const virtualSpace = document.querySelector('#virtual-space');
            const scene = document.querySelector('a-scene');

            // Hide virtual space
            virtualSpace.setAttribute('visible', false);

            // Clear all dynamic entities
            const dynamicEntities = scene.querySelectorAll('.location-entity');
            dynamicEntities.forEach((entity) => {
                scene.removeChild(entity);
            });
        }

        // Example function to show the cancel button with a fade effect
        function showCancelButton() {
            const cancelButton = document.getElementById('cancel-button');
            cancelButton.style.display = 'flex'; // Ensure it's visible
            setTimeout(() => {
                cancelButton.style.opacity = '1'; // Start the fade-in effect
            }, 10); // Small delay to allow the display change to take effect
        }

        // Example function to hide the cancel button with fade-out effect
        function hideCancelButton() {
            const cancelButton = document.getElementById('cancel-button');
            cancelButton.style.opacity = '0'; // Fade out the button
            setTimeout(() => {
                cancelButton.style.display = 'none'; // Hide it after the fade-out
            }, 500); // Match the duration of the fade-out (in this case, 0.5s)
        }

        function showNotification(entityname) {
            const notification = document.querySelector('.notification-container');
            const locationName = document.querySelector('.notification-box h1');

            locationName.textContent = entityname;
            notification.classList.remove('hide-notification'); // Remove fade-out class
            notification.classList.add('show-notification'); // Add fade-in class
            notification.style.display = 'flex'; // Ensure it's visible
        }

        function hideNotification() {
            const notification = document.querySelector('.notification-container');
            notification.classList.remove('show-notification'); // Remove fade-in class
            notification.classList.add('hide-notification'); // Add fade-out class

            // Ensure the element is hidden after the animation ends
            notification.addEventListener('animationend', () => {
                notification.style.display = 'none'; // Hide after animation ends
            }, { once: true });
        }


        const cancelButton = document.getElementById('cancel-button');
        cancelButton.addEventListener('click', function () {
            const virtualSpace = document.querySelector('#virtual-space');

            // Hide the cancel button
            hideCancelButton();

            // Hide virtual space
            virtualSpace.setAttribute('visible', false);

            clearVirtualSpace()

            refreshEntities();

            // Show the search form again
            const searchForm = document.getElementById('search-form');
            searchForm.style.display = 'block'; // Ensure the form is visible

        });

        // Clear entities and re-fetch/render them
        function refreshEntities() {
            fetchAndRenderEntities(); // Fetch and re-render entities from the database
        }

        function clearSceneEntities() {
            const scene = document.querySelector('a-scene');

            // Select all entities with the class 'dynamic-entity'
            const dynamicEntities = scene.querySelectorAll('.location-entity');

            // Loop through all dynamically created entities and remove them
            dynamicEntities.forEach((entity) => {
                const entityId = entity.getAttribute('data-entity-id');
                console.log(`Removing entity with ID: ${entityId}`); // Log which entity is being removed
                entity.parentNode.removeChild(entity); // Remove each dynamic entity
            });

            console.log("Cleared all dynamic entities.");
        }

        function showProximityMessage(message) {
            const virtualSpace = document.querySelector('#virtual-space');
            const proximityDiv = document.getElementById("proximity-message");
            const searchForm = document.getElementById("search-form");

            // Display and update the proximity message
            proximityDiv.innerText = message;
            proximityDiv.style.display = "block";
            proximityDiv.style.opacity = "1"; // Fade-in effect

            showNotification(message);

            // Add event listener if not already added
            if (!centerMenu.dataset.listener) {
                centerMenu.addEventListener('click', function () {
                    hideProximityMessage();
                    searchForm.style.display = "none";
                    showCancelButton();
                    virtualSpace.setAttribute('visible', true);
                    virtualSpace.setAttribute('follow-camera', '');
                    clearSceneEntities();
                    showDebugMessage(`You are viewing ${message} AR environment`);
                });

                // Mark the listener as added
                centerMenu.dataset.listener = 'true';
            }
        }

        // Function to hide the proximity message
        function hideProximityMessage() {
            const proximityDiv = document.getElementById("proximity-message");
            proximityDiv.style.opacity = "0"; // Fade-out effect\
            hideNotification();
            setTimeout(() => {
                proximityDiv.style.display = "none";
            }, 500); // Match this timeout with the CSS transition duration

        }

        // Function to check proximity and retrieve the Environment Model
        function checkProximity(userLat, userLon, entities, radius) {
            let isNearAnyEntity = false;

            let environmentModel = null; // To store the model for display

            entities.forEach(entity => {
                const distance = calculateDistance(userLat, userLon, entity.latitude, entity.longitude);
                if (distance <= radius) {
                    isNearAnyEntity = true;

                    showNotification(`${entity.name}`);
                    // showProximityMessage(`${entity.name}`);

                }
            });

            // Hide the center menu if the user is not near any entity
            if (!isNearAnyEntity) {
                hideNotification();
                // hideProximityMessage();
            }
        }


        // Function to show the plane and change the images
        let currentIndex = 0;
        function showImagePlane() {
            const plane = document.getElementById("image-plane");
            const camera = document.getElementById("camera");
            const currentEntity = window.dynamicEntities[10]; // For example, take the first entity

            if (currentEntity && currentEntity.eventImageLinks.length > 0) {
                const images = currentEntity.eventImageLinks;
                plane.setAttribute("visible", "true");

                // Set the first image
                plane.setAttribute("src", images[currentIndex]);

                // Loop through images
                setInterval(() => {
                    currentIndex = (currentIndex + 1) % images.length;
                    plane.setAttribute("src", images[currentIndex]);
                }, 3000); // Transition every 3 seconds
            }
        }



        function showEnvironmentModel(userLat, userLon, entity) {
            // Find the AR scene
            const scene = document.querySelector('a-scene');

            // Create a new entity for the environment model
            const environmentEntity = document.createElement('a-entity');
            environmentEntity.setAttribute('gps-entity-place', `latitude: ${userLat}; longitude: ${userLon}`);
            environmentEntity.setAttribute('gltf-model', '#f315Scene'); // Use the provided model
            environmentEntity.setAttribute('scale', '400 400 400'); // Default scale, can be adjusted as needed
            environmentEntity.setAttribute('look-at', '[gps-camera]'); // Always face the camera

            // Optionally, add animation or other attributes
            environmentEntity.setAttribute('animation-mixer', 'clip: *'); // Optional animation

            // Append the environment entity to the scene
            scene.appendChild(environmentEntity);

            // Log the correct model name for debugging
            showDebugMessage(`Entity created at coordinates: Latitude: ${userLat}, Longitude: ${userLon}, Model: ${entity.model}`);
        }








        // Update the location continuously with system popup for errors
        function updateLocation() {
            navigator.geolocation.watchPosition(
                function (position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    // Update the user's location display
                    updateLocationDisplay(latitude, longitude);

                    // Check if the user is near any entity (within a 25-meter radius)
                    checkProximity(latitude, longitude, window.dynamicEntities, 30);
                },
                function (error) {
                    // Handle different types of errors and show system alert popup
                    let message = "";
                    switch (error.code) {
                        case 1:
                            message = "Permission denied. Please enable location access in your browser settings.";
                            break;
                        case 2:
                            message = "Position unavailable. Please check your GPS or internet connection.";
                            break;
                        case 3:
                            message = "Request timed out. Please try again.";
                            break;
                        default:
                            message = "An unknown error occurred. Please refresh and try again.";
                            break;
                    }
                    // Display system alert popup
                    alert(message);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
        }

        // Call the function to start updating the location
        updateLocation();


        // Your Mapbox Token Specifically for UM.AR domain
        const MAPBOX_TOKEN = 'sk.eyJ1IjoiaGF6aXFodWR6YWlyeTAyIiwiYSI6ImNtM3VvYzduZDBqazgyanIzOTdibXM1c3IifQ.IRA9AZlLo-eF9uXsQkzdmg';

        let start = []; // User's coordinates
        let end = [];   // Destination coordinates

        function setNavigationCoordinates(destinationLatitude, destinationLongitude) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLatitude = position.coords.latitude;
                    const userLongitude = position.coords.longitude;
                    start = [userLatitude, userLongitude];
                    end = [destinationLatitude, destinationLongitude];

                    // Format debug message
                    const debugMessage = `Start Coordinates (User): ${start.join(', ')}\nEnd Coordinates (Destination): ${end.join(', ')}`;

                    // Call showDebugMessage with the formatted message
                    showDebugMessage(debugMessage);

                    renderRoute();

                    // Optionally perform additional actions, like fetching routes or updating UI
                },
                (error) => {
                    console.error("Error getting user's location:", error);
                }
            );
        }



        // Fetch route data from Mapbox Directions API
        async function fetchRoute(start, end) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${start[1]},${start[0]};${end[1]},${end[0]}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0].geometry.coordinates; // Array of waypoints
                } else {
                    console.error("No route found.");
                    return [];
                }
            } catch (error) {
                console.error('Error fetching route:', error);
                return [];
            }
        }

        // Function to interpolate points along the polyline
        function densifyPolyline(polyline, interval) {
            const points = [];
            for (let i = 0; i < polyline.length - 1; i++) {
                const [lon1, lat1] = polyline[i];
                const [lon2, lat2] = polyline[i + 1];
                const segmentPoints = interpolatePoints(lat1, lon1, lat2, lon2, interval); // 1 meter interval
                points.push(...segmentPoints);
            }
            return points;
        }

        // Helper function to interpolate points
        function interpolatePoints(lat1, lon1, lat2, lon2, interval) {
            const points = [];
            const R = 6371e3; // Earth’s radius in meters
            const φ1 = (lat1 * Math.PI) / 180;
            const φ2 = (lat2 * Math.PI) / 180;
            const Δφ = ((lat2 - lat1) * Math.PI) / 180;
            const Δλ = ((lon2 - lon1) * Math.PI) / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in meters

            const steps = Math.ceil(distance / interval); // Number of markers
            for (let i = 0; i <= steps; i++) {
                const fraction = i / steps;
                const lat = lat1 + (lat2 - lat1) * fraction;
                const lon = lon1 + (lon2 - lon1) * fraction;
                points.push([lon, lat]);
            }
            return points;
        }

        function clearMarkers() {
            const scene = document.querySelector('a-scene');

            // Select and remove all route markers and wrappers (including start/end labels)
            scene.querySelectorAll('.route-marker-wrapper, .route-marker').forEach((marker) => {
                marker.parentNode.removeChild(marker);
            });
        }

        // Render AR markers for the densified route
        async function renderRoute() {
            clearMarkers(); // Clear existing markers for the route

            const route = await fetchRoute(start, end); // Fetch route
            if (!route || route.length === 0) return;

            const densifiedPoints = densifyPolyline(route, 3); // Densify polyline

            // Render markers with jumping animation using a wrapper entity
            densifiedPoints.forEach(([lon, lat], index) => {
                // Wrapper entity to animate
                const wrapper = document.createElement('a-entity');
                wrapper.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon}`);
                wrapper.classList.add('route-marker-wrapper'); // Add a unique class

                // Create the actual marker as a child of the wrapper
                const marker = document.createElement('a-entity');
                marker.setAttribute('geometry', 'primitive: box; depth: 3; height: 1; width: 1');
                marker.setAttribute('material', 'color: lightblue');
                marker.setAttribute('scale', '0.5 0.5 0.5');
                marker.setAttribute('look-at', '[gps-camera]');
                marker.classList.add('route-marker'); // Add a unique class

                // Append the marker to the wrapper
                wrapper.appendChild(marker);

                marker.setAttribute('animation__scale', `
                    property: scale;
                    dir: alternate;
                    dur: 2500;
                    easing: easeInOutSine;
                    loop: true;
                    to: 0.5 1 0.5;
                    delay: ${index * 200};
                `);
                marker.setAttribute('animation__color', `
                    property: material.color;
                    dir: alternate;
                    dur: 2500;
                    easing: easeInOutSine;
                    loop: true;
                    to: yellow;
                    delay: ${index * 200};
                `);

                // Append the wrapper to the scene
                document.querySelector('a-scene').appendChild(wrapper);
            });
            // Add Start and End labels
            const [startLon, startLat] = route[0];
            const startLabel = document.createElement('a-text');
            startLabel.setAttribute('value', 'Start');
            startLabel.setAttribute('gps-entity-place', `latitude: ${startLat}; longitude: ${startLon}`);
            startLabel.setAttribute('color', 'white');
            startLabel.setAttribute('scale', '10 10 10');
            startLabel.classList.add('route-marker'); // Add a unique class
            document.querySelector('a-scene').appendChild(startLabel);

            const [endLon, endLat] = route[route.length - 1];
            const endLabel = document.createElement('a-text');
            endLabel.setAttribute('value', 'End');
            endLabel.setAttribute('gps-entity-place', `latitude: ${endLat}; longitude: ${endLon}`);
            endLabel.setAttribute('color', 'white');
            endLabel.setAttribute('scale', '10 10 10');
            endLabel.classList.add('route-marker'); // Add a unique class
            document.querySelector('a-scene').appendChild(endLabel);
        }

        // Call the render function after the scene is loaded
        document.querySelector('a-scene').addEventListener('loaded', function () {
            renderRoute(); // Render route markers
        });

        async function fetchTurnByTurnDirections(start, end) {
            const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${start[1]},${start[0]};${end[1]},${end[0]}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.routes && data.routes.length > 0) {
                    // Extract the steps from the route response
                    const steps = data.routes[0].legs[0].steps;
                    displayDirections(steps);  // Call function to display instructions
                } else {
                    console.error("No route found.");
                }
            } catch (error) {
                console.error('Error fetching route:', error);
            }
        }

        // Function to display the turn-by-turn instructions
        function displayDirections(steps) {
            const directionsContainer = document.getElementById("directions-container");
            directionsContainer.innerHTML = ''; // Clear any existing directions

            steps.forEach((step, index) => {
                const instruction = step.maneuver.instruction;
                const distance = step.distance; // Distance for this step
                const time = step.duration; // Duration for this step (in seconds)

                // Create a new element for the instruction and append to the container
                const stepElement = document.createElement('div');
                stepElement.className = "direction-step";
                stepElement.innerHTML = `
                <p>Step ${index + 1}: ${instruction}</p>
                <p>Distance: ${(distance / 1000).toFixed(2)} km</p>
                <p>Time: ${(time / 60).toFixed(0)} min</p>
            `;
                directionsContainer.appendChild(stepElement);
            });
        }


        const arScene = document.getElementById("ar-scene");
        const sceneRect = arScene.getBoundingClientRect();

        const cameraComponent = document.querySelector('a-camera').components.camera;
        const fov = cameraComponent ? cameraComponent.camera.fov : 'Not Found';
        const aspectRatio = cameraComponent ? cameraComponent.camera.aspect : 'Not Found';

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        // showDebugMessage(`
        //     Debug Info: <br>
        //     Viewport Dimensions: ${viewportWidth}px x ${viewportHeight}px <br>
        //     Scene Dimensions: ${sceneRect.width}px x ${sceneRect.height}px <br>
        //     Scene Position: Top ${sceneRect.top}px, Left ${sceneRect.left}px <br>
        //     Camera FOV: ${fov}° <br>
        //     Camera Aspect Ratio: ${aspectRatio}
        // `);

    </script>
</body>

</html>