<!doctype html>
<html>

<head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="Styles.css">
    <link rel="stylesheet" href="MarkerBased.css">

</head>

<body style="margin: 0; overflow: hidden;">

    <div class="container">
        <div class="logo-container">
            <!-- First logo -->
            <img src="asset/University_of_Malaya-Logo.png" alt="UM Logo" class="logoTop">
            <img src="asset/UM.AR_Logo_Font_Black.png" alt="UM AR Logo" class="logoTop">
        </div>

        <a href="main.html" class="backButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="white"
                class="bi bi-arrow-left-circle-fill" viewBox="0 0 16 16">
                <path
                    d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0m3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z" />
            </svg>
        </a>
    </div>

    <div class="expandable-button" onclick="toggleExpand()">
        <i class="bus-icon">ðŸšŒ</i>
        <div class="list">
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item"></div>
            <div class="list-item">View All Routes</div>
            <div class="list-item">Kolej Kediaman 1</div>
            <div class="list-item">Kolej Kediaman 12</div>
            <div class="list-item">Kolej Kediaman 11</div>
            <div class="list-item">Kolej Kediaman 5</div>
            <div class="list-item">Kolej Kediaman 13</div>
            <div class="list-item">Kolej Kediaman 9</div>
            <div class="list-item">Kolej Kediaman 8-10</div>
            <div class="list-item">Kolej Kediaman 3-4-7</div>
            <div class="list-item">Faculty of Engineering</div>
            <div class="list-item">Centre of Foundation in Science</div>
            <div class="list-item">KTM Angkasapuri Station</div>
            <div class="list-item">Pantai Permai</div>
            <div class="list-item">Bangsar South</div>
            <div class="list-item">International House</div>
            <div class="list-item">International House outside KK13</div>
            <div class="list-item">Rapid Stop 1-2-3-4-5</div>
            <div class="list-item">Academy of Malay Study</div>
            <div class="list-item">Academy of Islamic Study</div>
            <div class="list-item" style="color: red; margin-top: 10px;">Exit Environment</div>
        </div>
    </div>


    <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;" renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded>
        <a-assets>
            <!-- <a-asset-item id="Dog" src="asset/asset.gltf"></a-asset-item>
            <a-asset-item id="Environment" src="asset/CloudScene.glb"></a-asset-item>
            <a-asset-item id="Gundam" src="asset/Gundam.glb"></a-asset-item>
            <a-asset-item id="InfoContainer1" src="asset/console.glb"></a-asset-item>
            <a-asset-item id="FSKTMLogo" src="asset/FSKTMAnim3.glb"></a-asset-item>
            <a-asset-item id="TV" src="asset/tv.glb"></a-asset-item>
            <a-asset-item id="Pin" src="asset/LocationPin.glb"></a-asset-item>
            <video muted id="FSKTMVideo"
                src="Videos/Welcome to Faculty of Computer Science and Information Technology, University of Malaya.mp4"
                autoplay loop="true"></video>
            <img id="WelcomePhoto" src="asset/WelcomToFSKTM.png"></img> -->
            <img id="RouteA" src="asset/ARIllustration.png"></img>
            <img id="UMCentral" src="asset/BusRoute/Bus_route_UMCentral.png"></img>


            <img id="View-All-Routes" src="asset/UMCentralBusStop/UMCentral.png" />
            <img id="KTM-Angkasapuri-Station" src="asset/UMCentralBusStop/Angkasapuri.png" />
            <img id="Academy-of-Islamic-Study" src="asset/UMCentralBusStop/API.png" />
            <img id="Academy-of-Malay-Study" src="asset/UMCentralBusStop/APM.png" />
            <img id="Bangsar-South" src="asset/UMCentralBusStop/BangsarSouth.png" />
            <img id="Faculty-of-Engineering" src="asset/UMCentralBusStop/Engineering.png" />
            <img id="International-House" src="asset/UMCentralBusStop/InternationalHouse.png" />
            <img id="International-House-outside-KK13" src="asset/UMCentralBusStop/InternationalHouse(Outside).png" />
            <img id="Kolej-Kediaman-1" src="asset/UMCentralBusStop/KK1.png" />
            <img id="Kolej-Kediaman-11" src="asset/UMCentralBusStop/KK11.png" />
            <img id="Kolej-Kediaman-12" src="asset/UMCentralBusStop/KK12.png" />
            <img id="Kolej-Kediaman-13" src="asset/UMCentralBusStop/KK13.png" />
            <img id="Kolej-Kediaman-3-4-7" src="asset/UMCentralBusStop/KK3,KK4&KK7.png" />
            <img id="Kolej-Kediaman-5" src="asset/UMCentralBusStop/KK5.png" />
            <img id="Kolej-Kediaman-8-10" src="asset/UMCentralBusStop/KK8&KK10.png" />
            <img id="Kolej-Kediaman-9" src="asset/UMCentralBusStop/KK9.png" />
            <img id="Pantai-Permai" src="asset/UMCentralBusStop/PantaiPermai.png" />
            <img id="Centre-of-Foundation-in-Science" src="asset/UMCentralBusStop/PASUM.png" />
            <img id="Rapid-Stop-1-2-3-4-5" src="asset/UMCentralBusStop/Rapid12345.png" />

            <a-asset-item id="board" src="asset/AR_Environment_Info/realistic_blackboard.glb"></a-asset-item>
        </a-assets>

        <a-marker id="UMC-marker" type="pattern" url="asset/Marker/pattern-UMC.patt" emitevents="true">
            <a-image id="umc-img" src="#UMCentral" scale="0.1 0.1 0.1" rotation="-90 0 0" class="clickable"
                gesture-handler></a-image>
        </a-marker>

        <a-marker id="bus-stop-marker" type="pattern" url="asset/Marker/pattern-BSKK10.patt" emitevents="true">
            <a-image id="routeA-img" src="#RouteA" scale="3 3 3" class="clickable" gesture-handler
                rotation="-90 0 0"></a-image>
        </a-marker>

        <!-- Environment -->
        <a-entity id="BusRouteUMC" visible="false">
            <a-plane material="src: #UMCentral" width="5" height="3" position="0 0 -5"></a-plane>
        </a-entity>


        <!-- Camera -->
        <a-entity camera look-controls></a-entity>
    </a-scene>

    <div class="scanner-container">
        <div class="scanner-line"></div>
        <div class="corners corner-top-left"></div>
        <div class="corners corner-top-right"></div>
        <div class="corners corner-bottom-left"></div>
        <div class="corners corner-bottom-right"></div>
    </div>


    <script>

        function toggleExpand() {
            const button = document.querySelector('.expandable-button');
            const list = document.querySelector('.list');
            button.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const busRouteUMC = document.querySelector('#BusRouteUMC');
            const expandableButton = document.querySelector('.expandable-button');
            const umcMarker = document.querySelector('#UMC-marker');

            const listItems = document.querySelectorAll('.list-item');
            const busRouteUMCPlane = document.querySelector('#BusRouteUMC a-plane');

            // Event listener for list items
            listItems.forEach((item) => {
                item.addEventListener('click', () => {
                    const itemText = item.textContent.trim();

                    // Check if "Exit Environment" is clicked
                    if (itemText === 'Exit Environment') {
                        // Hide the BusRouteUMC and the expandable button
                        busRouteUMC.setAttribute('visible', 'false');
                        expandableButton.style.display = 'none';
                        console.log('Exited environment: BusRouteUMC and button hidden');
                    } else {
                        // Handle other list items
                        const targetImageId = `#${itemText.replace(/\s+/g, '-').replace(/\//g, '-')}`;
                        const targetImage = document.querySelector(targetImageId);

                        if (targetImage) {
                            // Update the material source of the plane
                            const busRouteUMCPlane = document.querySelector('#BusRouteUMC a-plane');
                            busRouteUMCPlane.setAttribute('material', `src: ${targetImageId}`);
                            console.log(`Updated plane texture to ${targetImageId}`);
                        } else {
                            console.error(`Image with ID ${targetImageId} not found.`);
                        }
                    }
                });
            });

            // Ensure the button is initially hidden
            expandableButton.style.display = 'none';

            if (umcMarker && busRouteUMC) {
                umcMarker.addEventListener('markerFound', () => {
                    // Make BusRouteUMC permanently visible
                    busRouteUMC.setAttribute('visible', 'true');
                    expandableButton.style.display = 'flex'; // Show the button
                });

                umcMarker.addEventListener('markerLost', () => {
                    // The button remains visible, and BusRouteUMC stays visible
                    console.log('Marker lost, but BusRouteUMC remains visible.');
                });
            } else {
                console.error('UMC marker or BusRouteUMC entity not found.');
            }
        });



        // // Get a reference to the video element
        // var video = document.querySelector('#FSKTMVideo');

        // Function to check the camera permission status
        function checkCameraPermission() {
            // Check if getUserMedia is supported by the browser
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Check if the camera permission is granted
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function (stream) {
                        console.log('Camera access granted. AR scene is ready.');
                        document.getElementById("scanner-container").style.display = "block";
                        // Do further initialization here
                    })
                    .catch(function (error) {
                        console.log('Failed to access camera:', error);
                        // Handle camera access denied or failed state here
                    });
            } else {
                console.log('getUserMedia not supported by the browser.');
            }
        }



        let originPosition = null;

        // Function to initialize the AR environment
        function initializeAREnvironment() {
            const marker = document.querySelector("#origin-marker");
            const virtualSpace = document.querySelector("#virtual-space");

            // Set the position of the virtual space based on the marker's position
            const markerPosition = new THREE.Vector3();
            marker.object3D.getWorldPosition(markerPosition);

            if (!originPosition) {
                originPosition = markerPosition.clone();
            }

            virtualSpace.object3D.position.copy(originPosition);

            //document.querySelector("#QR-animation").style.display = "none";

            // Show the virtual space
            virtualSpace.setAttribute('visible', true);

            // Check if the video element exists
            if (video) {
                setTimeout(function () {
                    // Autoplay the video
                    video.play();
                }, 2000); // 3000 milliseconds = 3 seconds
            }
        }

        // // Marker found event
        // document.querySelector("#origin-marker").addEventListener("markerFound", (e) => {
        //     initializeAREnvironment();
        // });


        // Model loaded event to debug animation clips and play all animations
        document.querySelectorAll('a-entity[gltf-model]').forEach((entity) => {
            entity.addEventListener('model-loaded', (e) => {
                const model = e.detail.model;
                const animations = model.animations;

                if (animations && animations.length > 0) {
                    console.log('Available animation clips:', animations.map(anim => anim.name));
                    const mixer = new THREE.AnimationMixer(model);
                    animations.forEach((clip) => {
                        const action = mixer.clipAction(clip);
                        action.play();
                    });

                    const clock = new THREE.Clock();

                    const animate = () => {
                        requestAnimationFrame(animate);
                        const delta = clock.getDelta();
                        mixer.update(delta);
                    };

                    animate();
                } else {
                    console.log('No animations found for model:', entity);
                }
            });
        });






    </script>

</body>

</html>