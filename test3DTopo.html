<html>

<head>
    <meta charset="utf-8" />
    <title>3D Map with Joysticks for Movement and Rotation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.3.4/dist/Threebox.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #joystick-container-move,
        #joystick-container-rotate {
            position: absolute;
            width: 150px;
            height: 150px;
            z-index: 10;
        }

        #joystick-container-move {
            bottom: 50px;
            left: 50px;
        }

        #joystick-container-rotate {
            bottom: 50px;
            right: 50px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="joystick-container-move"></div>
    <div id="joystick-container-rotate"></div>
    <script>
        // Initialize Mapbox
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [101.653585, 3.120975], // Initial coordinates
            zoom: 150,
            pitch: 90, // Default tilt
            bearing: 0, // Default rotation
            antialias: true,
            accessToken: 'pk.eyJ1IjoiamFpcnkxOTExIiwiYSI6ImNsd3dscGdyMDExb3gyaXBncjlydWRzd2sifQ.vllbvi2AvqhKk6KIs85Mtg',
        });

        // Disable default drag for moving the map
        map.dragPan.disable();
        map.touchZoomRotate.enableRotation();
        map.touchZoomRotate.enable();

        // Joystick for Movement
        const moveJoystick = nipplejs.create({
            zone: document.getElementById('joystick-container-move'),
            mode: 'static',
            position: { left: '50%', bottom: '50%' },
            color: 'blue',
            size: 150
        });

        const movementSpeed = 0.00000005;
        let movementDirection = null;

        moveJoystick.on('move', function (evt, data) {
            if (data.angle && data.distance) {
                const angle = data.angle.degree;
                const distance = data.distance;
                movementDirection = { angle, distance };
            }
        });

        moveJoystick.on('end', function () {
            movementDirection = null;
        });

        setInterval(() => {
            if (movementDirection) {
                const center = map.getCenter();
                const mapBearing = map.getBearing();
                const adjustedAngle = (movementDirection.angle - mapBearing + 360) % 360;
                const radianAngle = (adjustedAngle * Math.PI) / 180;

                const deltaLng = movementSpeed * Math.cos(radianAngle) * movementDirection.distance;
                const deltaLat = movementSpeed * Math.sin(radianAngle) * movementDirection.distance;

                map.setCenter([center.lng + deltaLng, center.lat + deltaLat]);
            }
        }, 16);

        // Joystick for Rotation
        const rotateJoystick = nipplejs.create({
            zone: document.getElementById('joystick-container-rotate'),
            mode: 'static',
            position: { right: '50%', bottom: '50%' },
            color: 'red',
            size: 150
        });

        const rotationSpeed = 0.5;
        let rotationDirection = null;

        rotateJoystick.on('move', function (evt, data) {
            if (data.angle) {
                const angle = data.angle.degree;
                rotationDirection = angle >= 90 && angle <= 270 ? -1 : 1; // Left or right
            }
        });

        rotateJoystick.on('end', function () {
            rotationDirection = null;
        });

        setInterval(() => {
            if (rotationDirection !== null) {
                map.setBearing(map.getBearing() + rotationSpeed * rotationDirection);
            }
        }, 16);

        map.on('load', function () {
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(layer => layer.type === 'symbol' && layer.layout['text-field'])?.id;

            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                filter: ['==', 'extrude', 'true'],
                type: 'fill-extrusion',
                minzoom: 15,
                paint: {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            }, labelLayerId);
        });
    </script>
</body>

</html>
