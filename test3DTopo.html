<html>

<head>
    <meta charset="utf-8" />
    <title>3D Map with Joystick for Movement</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #joystick-container {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 150px;
            height: 150px;
            z-index: 10;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="joystick-container"></div>
    <script>
        // Initialize Mapbox
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [101.653585, 3.120975], // Initial coordinates
            zoom: 150,
            pitch: 90,
            bearing: 0,
            antialias: true,
            accessToken: 'pk.eyJ1IjoiamFpcnkxOTExIiwiYSI6ImNsd3dscGdyMDExb3gyaXBncjlydWRzd2sifQ.vllbvi2AvqhKk6KIs85Mtg'
        });

// Disable default drag for moving the map
map.dragPan.disable();

// Enable touch gestures for rotation and zoom only
map.touchZoomRotate.enableRotation();
map.touchZoomRotate.enable();

        // Joystick for Movement
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick-container'),
            mode: 'static',
            position: { left: '50%', bottom: '50%' },
            color: 'blue',
            size: 150
        });

        // Speed multiplier for movement
const movementSpeed = 0.0000001;

// Variable to track movement interval
let movementInterval = null;
let angle = null; // Current angle of movement
let distance = 0; // Current distance from joystick center

// Start movement when joystick is moved
joystick.on('move', function (evt, data) {
    if (data.angle && data.distance) {
        angle = data.angle.degree; // Get angle in degrees
        distance = data.distance; // Get distance from joystick center

        // Start movement if not already moving
        if (!movementInterval) {
            movementInterval = setInterval(() => {
                if (angle !== null && distance > 0) {
                    const center = map.getCenter();
                    let lng = center.lng;
                    let lat = center.lat;

                    // Get the current map bearing (rotation)
                    const mapBearing = map.getBearing(); // In degrees

                    // Adjust joystick angle based on map rotation
                    const adjustedAngle = (angle - mapBearing + 360) % 360; // Normalize to 0â€“360
                    const radianAngle = (adjustedAngle * Math.PI) / 180;

                    // Calculate movement offsets
                    const deltaLng = movementSpeed * Math.cos(radianAngle) * distance;
                    const deltaLat = movementSpeed * Math.sin(radianAngle) * distance;

                    // Update map center
                    lng += deltaLng;
                    lat += deltaLat;

                    map.setCenter([lng, lat]);
                }
            }, 16); // Update ~60 times per second
        }
    }
});

// Stop movement when joystick is released
joystick.on('end', function () {
    if (movementInterval) {
        clearInterval(movementInterval); // Stop movement
        movementInterval = null;
    }
    angle = null; // Clear angle
    distance = 0; // Reset distance
});


        map.on('load', function () {
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(layer => layer.type === 'symbol' && layer.layout['text-field'])?.id;

            map.addLayer({
                id: '3d-buildings',
                source: 'composite',
                'source-layer': 'building',
                filter: ['==', 'extrude', 'true'],
                type: 'fill-extrusion',
                minzoom: 15,
                paint: {
                    'fill-extrusion-color': '#aaa',
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.6
                }
            }, labelLayerId);
        });
    </script>
</body>

</html>