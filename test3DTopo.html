<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>3D Map with Joystick in VR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-mapbox-component/dist/aframe-mapbox-component.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        body {
            margin: 0;
        }

        #joystick-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            z-index: 10;
        }
    </style>
</head>

<body>
    <div id="joystick-container"></div>
    <a-scene>
        <!-- Add the Mapbox 3D Map -->
        <a-entity id="map"
                  mapbox="accessToken: pk.eyJ1IjoiamFpcnkxOTExIiwiYSI6ImNsd3dscGdyMDExb3gyaXBncjlydWRzd2sifQ.vllbvi2AvqhKk6KIs85Mtg;
                          style: mapbox://styles/mapbox/streets-v12;
                          center: 101.653585,3.120975;
                          zoom: 150;
                          pitch: 90;
                          bearing: 0;">
        </a-entity>

        <!-- Add a camera for VR -->
        <a-entity id="camera" camera look-controls wasd-controls position="0 1.6 0"></a-entity>
    </a-scene>

    <script>
        // Initialize Joystick for Movement
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick-container'),
            mode: 'static',
            position: { left: '50%', bottom: '50%' },
            color: 'blue',
            size: 150
        });

        const mapEntity = document.querySelector("#map");
        let movementInterval = null;
        let angle = null;
        let distance = 0;

        // Movement speed
        const movementSpeed = 0.0001;

        // Joystick movement logic
        joystick.on('move', function (evt, data) {
            if (data.angle && data.distance) {
                angle = data.angle.degree; // Get angle in degrees
                distance = data.distance; // Get distance from joystick center

                if (!movementInterval) {
                    movementInterval = setInterval(() => {
                        if (angle !== null && distance > 0) {
                            // Adjust movement based on joystick angle
                            const radianAngle = (angle * Math.PI) / 180;

                            const deltaLng = movementSpeed * Math.cos(radianAngle) * distance;
                            const deltaLat = movementSpeed * Math.sin(radianAngle) * distance;

                            // Update map center
                            const currentCenter = mapEntity.getAttribute("mapbox").center.split(",");
                            const lng = parseFloat(currentCenter[0]) + deltaLng;
                            const lat = parseFloat(currentCenter[1]) + deltaLat;

                            mapEntity.setAttribute("mapbox", `center: ${lng},${lat}`);
                        }
                    }, 16); // Update ~60 FPS
                }
            }
        });

        // Stop movement when joystick is released
        joystick.on('end', function () {
            if (movementInterval) {
                clearInterval(movementInterval);
                movementInterval = null;
            }
            angle = null;
            distance = 0;
        });

        // Enable Device Orientation for Rotation
        if (window.DeviceOrientationEvent) {
            window.addEventListener("deviceorientation", (event) => {
                if (event.alpha !== null) {
                    const rotation = event.alpha; // Rotation around the Z-axis
                    mapEntity.setAttribute("mapbox", `bearing: ${rotation}`);
                }
            });
        } else {
            console.log("DeviceOrientation is not supported on this device.");
        }
    </script>
</body>

</html>
