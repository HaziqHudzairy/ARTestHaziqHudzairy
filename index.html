<!doctype html>
<html>
<head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.controls.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        id="scene"
        embedded

    >
        <a-assets>
            <a-asset-item id="Dog" src="asset/asset.gltf"></a-asset-item>
            <a-asset-item id="GameConsole" src="asset/Console_Game.gltf"></a-asset-item>
            <a-asset-item id="Console" src="asset/Console_Game.gltf"></a-asset-item>
        </a-assets>

        <a-entity
            position="0 1.5 -2" 
            text="value: Debug Text; align: center; width: 4; color: black; wrap-count: 20; font: mozillavr;" 
        ></a-entity>


        <!-- Origin marker -->
        <a-marker
            id="origin-marker"
            type="pattern"
            url="assets/marker.patt"
            emitevents="true"
        >
            <a-entity
                id="origin-model"
                scale="4.158927133771977 4.158927133771977 4.158927133771977"
                animation-mixer="loop: repeat"
                gltf-model="#GameConsole"
                class="clickable"
                gesture-handler
            ></a-entity>
        </a-marker>

        <!-- Virtual 3D space (initially hidden) -->
        <a-entity id="virtual-space" visible="false">

            <a-entity
                id="Dog"
                scale="2 2 2"
                gltf-model="#Dog"
                position="5 0 0"
            ></a-entity>
            <a-entity
                id="Game_Console"
                scale="6 6 6"
                gltf-model="#Console"
                position="-5 0 0"
                rotation="0 90 0"
            ></a-entity>

            <!-- Object in front of the camera (marker side) -->
            <a-entity
                id="object1"
                geometry="primitive: box; height: 0.3; width: 0.3; depth: 0.3"
                material="color: yellow"
                position="0 0 -2"
            ></a-entity>

            <!-- Object behind the camera -->
            <a-entity
                id="object2"
                geometry="primitive: sphere; radius: 0.2"
                material="color: cyan"
                position="0 0 8"
            ></a-entity>

            <!-- Object right of the camera -->
            <a-entity
                id="object3"
                geometry="primitive: sphere; radius: 0.2"
                material="color: blue"
                position="8 0 0"
            ></a-entity>

            <!-- Object left of the camera -->
            <a-entity
                id="object4"
                geometry="primitive: sphere; radius: 0.2"
                material="color: green"
                position="-8 0 0"
            ></a-entity>

            <!-- Object top of the camera -->
            <a-entity
                id="object5"
                geometry="primitive: sphere; radius: 0.2"
                material="color: red"
                position="0 8 0"
            ></a-entity>
        </a-entity>

        <!-- Camera -->
        <a-entity id="camera-wrapper">
            <a-entity camera look-controls gps-new-camera>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        let originPosition = null;
        let markerFound = false;

        // Function to convert latitude and longitude to 3D Cartesian coordinates
        function latLongToCartesian(latitude, longitude) {
            var latRad = latitude * Math.PI / 180;
            var longRad = longitude * Math.PI / 180;
            var earthRadius = 6371000; // Approximate value for Earth's radius in meters

            var x = earthRadius * Math.cos(latRad) * Math.cos(longRad);
            var z = earthRadius * Math.cos(latRad) * Math.sin(longRad);

            // Y coordinate can be set to 0 or any desired altitude
            var y = 0; // Assuming ground level

            return { x: x, y: y, z: z };
        }

        // Function to handle obtaining the current position
        function showPosition(position) {
            // Log latitude and longitude
            console.log("Latitude:", position.coords.latitude);
            console.log("Longitude:", position.coords.longitude);

            // Convert latitude and longitude to Cartesian coordinates
            var cartesianCoordinates = latLongToCartesian(position.coords.latitude, position.coords.longitude);
            console.log("Cartesian Coordinates:", cartesianCoordinates);
            
            if (!markerFound) {
                // Set the origin position to the current device location
                originPosition = cartesianCoordinates;
                console.log("Origin Position Set:", originPosition);
            }

            // Use the Cartesian coordinates for further operations (e.g., setting the position in the 3D space)
            console.log("Current position in 3D space:", cartesianCoordinates);

            // Update the position of the virtual space
            updateVirtualSpacePosition(cartesianCoordinates);
        }

        // Function to update the position of the virtual space
        function updateVirtualSpacePosition(position) {
            const virtualSpace = document.querySelector("#virtual-space");
            virtualSpace.object3D.position.set(position.x, position.y, position.z);
            console.log("Virtual Space Position Updated:", position);
        }

        // Obtain the current position
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            console.log("Geolocation is not supported by this browser.");
        }

        // Function to initialize the AR environment
        function initializeAREnvironment() {
            const marker = document.querySelector("#origin-marker");
            const virtualSpace = document.querySelector("#virtual-space");

            // Set the position of the virtual space based on the marker's position
            const markerPosition = new THREE.Vector3();
            marker.object3D.getWorldPosition(markerPosition);

            if (!originPosition) {
                originPosition = markerPosition.clone();
                console.log("Origin Position Set:", originPosition);
            }

            virtualSpace.object3D.position.copy(originPosition);
            console.log("Virtual Space Position Set:", originPosition);

            // Show the virtual space
            virtualSpace.setAttribute('visible', true);
            console.log("Virtual Space Visible:", true);

            // Set markerFound to true
            markerFound = true;
        }

        // Marker found event
        document.querySelector("#origin-marker").addEventListener("markerFound", (e) => {
            initializeAREnvironment();
            console.log("Marker Found:", true);
        });

        // Continuous update of position based on device geolocation
        setInterval(() => {
            if (markerFound) {
                navigator.geolocation.getCurrentPosition(showPosition);
                console.log("Continuous Position Update");
            }
        }, 1000); // Update every second

        // Function to handle device orientation and movement updates
        function handleOrientation(event) {
            // Get device orientation data
            const alpha = event.alpha; // Rotation around the z-axis (0 to 360 degrees)
            const beta = event.beta;   // Rotation around the x-axis (-180 to 180 degrees)
            const gamma = event.gamma; // Rotation around the y-axis (-90 to 90 degrees)

            // Update camera position and rotation based on device orientation
            const cameraWrapper = document.querySelector("#camera-wrapper");
            cameraWrapper.setAttribute("rotation", { x: beta, y: gamma, z: alpha }); // Adjust according to your camera setup
            console.log("Device Orientation Updated:", { alpha, beta, gamma });
        }

        // Listen for device orientation changes
        window.addEventListener("deviceorientation", handleOrientation);
    </script>
</body>
</html>

