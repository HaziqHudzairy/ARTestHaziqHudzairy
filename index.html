<!doctype html>
<html>
<head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="Styles.css">

</head>
<body style="margin: 0; overflow: hidden;">

    <div id="Loading"class="box">
        <div class="cat">
          <div class="cat__body"></div>
          <div class="cat__body"></div>
          <div class="cat__tail"></div>
          <div class="cat__head"></div>
        </div>
      </div>
    
    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        id="scene"
        embedded
    >
        <a-assets>
            <a-asset-item id="Dog" src="asset/asset.gltf"></a-asset-item>
            <a-asset-item id="Environment" src="asset/CloudsEnv.glb"></a-asset-item>
            <a-asset-item id="Gundam" src="asset/Gundam.glb"></a-asset-item>
            <a-asset-item id="InfoContainer1" src="asset/console.glb"></a-asset-item>
            <a-asset-item id="FSKTMLogo" src="asset/FSKTMAnim3.glb"></a-asset-item>
            <a-asset-item id="TV" src="asset/tv.glb"></a-asset-item>
            <a-asset-item id="Pin" src="asset/Location.glb"></a-asset-item>
            <video muted id="FSKTMVideo" src="Videos/Welcome to Faculty of Computer Science and Information Technology, University of Malaya.mp4" autoplay loop="true"></video>
        </a-assets>

        <!-- Origin marker -->
        <a-marker
            id="origin-marker"
            type="pattern"
            url="asset/marker.patt"
            emitevents="true"
        >
        <a-entity
            id="origin-model"
            scale="4.158927133771977 4.158927133771977 4.158927133771977"
            animation-mixer="loop: repeat"
            gltf-model="#GameConsole"
            class="clickable"
            gesture-handler
        ></a-entity>
        </a-marker>

        <!-- Virtual 3D space (initially hidden) -->
        <a-entity id="virtual-space" visible="false">
            <a-entity 
                id="Pin Location"
                scale="0.2 0.2 0.2"
                gltf-model="#Pin"
                position="0 4 -5"
            ></a-entity>
            <a-entity
                id="Fsktm"
                scale="2 2 2"
                gltf-model="#FSKTMLogo"
                position="0 0 -5"
            ></a-entity>
            <a-entity
                id="Env"
                scale="10 10 10"
                gltf-model="#Environment"
                position="0 -50 0"
                rotation="0 0 0"
            ></a-entity>
            <a-entity
                id="Env"
                scale="10 10 10"
                gltf-model="#Gundam"
                position="0 -60 0"
                rotation="0 0 0"
            ></a-entity>

            <a-entity
                id="ConsoleGame"
                scale="6 6 6"
                gltf-model="#InfoContainer1"
                position="12 -1 8"
                rotation="10 260 0"
            ></a-entity>

            <a-entity
                id="TVPlayer"
                scale="5.2 4 5 "
                gltf-model="#TV"
                position="18 -2.4 -5.37"
                rotation="0 -60 0"
            ></a-entity>

            
            <a-video src="#FSKTMVideo" width="8" height="4.5" position="14 2 -3.3" rotation="0 -60 0"></a-video>
             
        </a-entity>

        <!-- Camera -->
        <a-entity camera look-controls></a-entity>
    </a-scene>

    <div id="QR-animation" class="center" style="display:none;">
        <div class="square">
            <i class="fa fa-qrcode"></i>
            <div class="scan"></div>
        </div>
    </div>
    

    <script>

// Wait for the A-Frame scene to be fully loaded
document.querySelector('a-scene').addEventListener('loaded', function () {
    document.getElementById("Loading").style.display = "none";
    // Call the function to check camera permission status
    checkCameraPermission();
});

// Function to check the camera permission status
function checkCameraPermission() {
    // Check if getUserMedia is supported by the browser
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Check if the camera permission is granted
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                console.log('Camera access granted. AR scene is ready.');
                document.getElementById("QR-animation").style.display = "block";
                // Do further initialization here
            })
            .catch(function (error) {
                console.log('Failed to access camera:', error);
                // Handle camera access denied or failed state here
            });
    } else {
        console.log('getUserMedia not supported by the browser.');
    }
}

// Rest of your JavaScript code...

        
        
        let originPosition = null;
    
        // Function to initialize the AR environment
        function initializeAREnvironment() {
            const marker = document.querySelector("#origin-marker");
            const virtualSpace = document.querySelector("#virtual-space");
    
            // Set the position of the virtual space based on the marker's position
            const markerPosition = new THREE.Vector3();
            marker.object3D.getWorldPosition(markerPosition);
    
            if (!originPosition) {
                originPosition = markerPosition.clone();
            }
    
            virtualSpace.object3D.position.copy(originPosition);
    
            document.querySelector("#QR-animation").style.display = "none";
            
            // Show the virtual space
            virtualSpace.setAttribute('visible', true);
        }
    
        // Marker found event
        document.querySelector("#origin-marker").addEventListener("markerFound", (e) => {
            initializeAREnvironment();
        });

    
        // Model loaded event to debug animation clips and play all animations
        document.querySelectorAll('a-entity[gltf-model]').forEach((entity) => {
            entity.addEventListener('model-loaded', (e) => {
                const model = e.detail.model;
                const animations = model.animations;

                if (animations && animations.length > 0) {
                    console.log('Available animation clips:', animations.map(anim => anim.name));
                    const mixer = new THREE.AnimationMixer(model);
                    animations.forEach((clip) => {
                        const action = mixer.clipAction(clip);
                        action.play();
                    });

                    const clock = new THREE.Clock();

                    const animate = () => {
                        requestAnimationFrame(animate);
                        const delta = clock.getDelta();
                        mixer.update(delta);
                    };

                    animate();
                } else {
                    console.log('No animations found for model:', entity);
                }
            });
        });

        // Get a reference to the video element
        var video = document.querySelector('#FSKTMVideo');

        // Check if the video element exists
        if (video) {
            // Autoplay the video
            video.play();
        }

    </script>
    
</body>
</html>
